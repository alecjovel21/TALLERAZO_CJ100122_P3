<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tallerazo â€“ OTP & SPA</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    /* ğŸ¨ COLORES Y ESTILOS MODERNOS (Tallerazo Base) */
    :root {
        --bg: #0d1117; /* Fondo Oscuro */
        --card: #161b22; /* Tarjeta Ligeramente mÃ¡s clara */
        --pri: #2f81f7; /* Azul Primario para acciÃ³n */
        --pri-hover: #54a3ff;
        --txt: #c9d1d9; /* Texto Gris claro */
        --mut: #8b949e; /* Texto Opaco */
        --border: #30363d; /* Color de Borde */
        --ok: #3fb950; /* Verde de Ã‰xito */
        --bad: #f85149; /* Rojo de Error */
        /* Colores de UbicaciÃ³n/Mapa (Tomados de tu cÃ³digo) */
        --map-pri: #00bcd4;
        --map-dark: #1f1f1f;
        --map-gradient-dark: #1a1a2e;
    }
    *{box-sizing:border-box} 
    body{margin:0;font-family:system-ui, sans-serif;background:var(--bg);color:var(--txt); line-height: 1.5;}
    .wrap{max-width:900px; /* Aumentado para la vista de mapa */ margin:80px auto;padding:0 20px}
    .card{background:var(--card);border-radius:12px;padding:30px;box-shadow:0 15px 35px rgba(0,0,0,.5), 0 5px 15px rgba(0,0,0,.25); border: 1px solid var(--border);}
    h1,h2,h3{margin:0 0 16px; color: #f0f6fc;} 
    h1{font-size:32px; font-weight: 600;} 
    h2{font-size:24px; font-weight: 500;} 
    p{color:var(--mut); margin-bottom: 20px;}
    
    input, button{
        width:100%;padding:14px 16px;border-radius:8px;
        border:1px solid var(--border);
        font-size:16px;
        transition: all 0.2s ease;
    }
    
    input{
        background:#0d1117;
        color:var(--txt);
    }
    input:focus {
        border-color: var(--pri);
        box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3);
        outline: none;
    }
    input::placeholder{color:var(--mut)} 
    
    button{
        background:var(--pri);border:none;font-weight:600;cursor:pointer;color:#ffffff;
    }
    button:hover:not(:disabled) {
        background: var(--pri-hover);
    }
    button:disabled{opacity:.7;cursor:not(:allowed); background: #213c5c;}
    
    .row{display:grid;gap:15px;margin:20px 0}
    .mut{font-size:14px;color:var(--mut); margin-top: 10px;}
    .ok{color:var(--ok); font-weight: 500;}
    .bad{color:var(--bad); font-weight: 500;}
    
    /* Estilos del Dashboard */
    .toolbar{display:flex;gap:12px;margin:16px 0}
    .toolbar input { flex-grow: 1; margin-right: 0;}
    .toolbar button { width: auto; min-width: 100px; padding: 10px 15px; }
    .grid{display:grid;gap:20px; margin-top: 25px;}
    .tile{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:20px;}
    .tile h3 {margin-top: 0; margin-bottom: 10px; font-size: 18px; color: var(--pri);}
    .tile p.mut { margin-bottom: 15px; }
    
    .badge{display:inline-block;background:var(--border);border:1px solid #444c56;padding:4px 10px;border-radius:20px;font-size:13px;color:#f0f6fc}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    nav a{color:var(--mut);text-decoration:none;margin-right:15px; padding: 5px 0;}
    nav a.active{color:var(--txt); font-weight: 500; border-bottom: 2px solid var(--pri);}
    nav { margin-bottom: 20px;}
    .hidden{display:none}

    /* Estilos para el Bot (Dialogflow) */
    .bot-container {
        display: block !important; 
        position: fixed;
        bottom: 0;
        right: 0;
        z-index: 1000; 
    }

    /* ğŸ“ ESTILOS DE LA VISTA /ubicacion (Adaptados al tema oscuro) */
    .map-container {
        padding-top: 20px;
    }
    .map-header h2 {
        font-size: 32px;
        background: linear-gradient(135deg, var(--map-pri) 0%, #00e5ff 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        margin-bottom: 35px;
    }
    #map-sucursales {
        width: 100%;
        height: 550px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        overflow: hidden;
        border: 1px solid rgba(0, 188, 212, 0.3);
    }
    /* Sobrescribir estilos de pop-up de Leaflet para el tema oscuro */
    .leaflet-popup-content-wrapper {
        background: var(--card);
        color: var(--txt);
        border-radius: 8px;
        border: 1px solid var(--border);
    }
    .leaflet-popup-tip {
        background: var(--card);
    }
    .leaflet-popup-content {
        margin: 10px;
        font-family: inherit;
    }

    /* Cards de Sucursales */
    .branches {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 40px;
    }
    .section-title {
        grid-column: 1 / -1;
        color: var(--map-pri);
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 10px;
    }
    .branch-card {
        display: flex;
        flex-direction: column;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .branch-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 188, 212, 0.2);
        border-color: var(--map-pri);
    }
    .branch-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    .branch-info {
        padding: 15px;
    }
    .branch-info h3 {
        color: var(--map-pri);
        font-size: 18px;
        margin-bottom: 6px;
    }
    .branch-info p {
        color: var(--mut);
        font-size: 13px;
        margin-bottom: 0;
    }
    .branch-link {
        display: inline-block;
        margin-top: 8px;
        color: var(--pri);
        font-size: 13px;
        font-weight: 500;
    }

</style>
</head>
<body>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

Â  <div class="wrap">
Â  Â  Â  Â  <div id="app"></div>
Â  </div>

<div id="bot-container" class="bot-container">
    <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
    <df-messenger
      intent="WELCOME"
      chat-title="Asistente Virtual"
      agent-id="e9cd8eb2-97a8-4fee-8811-d26b411ab1a1"
      language-code="es"
      chat-icon="https://cdn-icons-png.flaticon.com/512/4712/4712035.png"
      user-id="cliente_actual"
      wait-open
      theme="dark">
    </df-messenger>
</div>

<script>
/* =========================
Â  Â âš™ï¸ CONFIG EmailJS
Â  Â ========================= */
const EMAILJS_SERVICE_ID = "service_piisedm"; 
const EMAILJS_TEMPLATE_ID = "template_ryjxhlr"; 
const EMAILJS_PUBLIC_KEY = "nIRHmGazV-tAUIiu-"; Â  Â  Â 
const APP_NAME = "Tallerazo";

/* =========================
Â  Â ğŸ” OTP client-side (demo)
Â  Â ========================= */
const OTP_TTL_MS = 5 * 60 * 1000; // 5 min
function genOTP(){ return String(Math.floor(100000 + Math.random()*900000)); }
async function sha256(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-256', enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join(""); }
function saveOtp(email, otpHash){
Â  const rec = { email, otpHash, exp: Date.now()+OTP_TTL_MS, attempts:0 };
Â  sessionStorage.setItem("tallerazo_otp", JSON.stringify(rec));
}
function readOtp(){ try{ return JSON.parse(sessionStorage.getItem("tallerazo_otp")||"null"); }catch{ return null; } }
function clearOtp(){ sessionStorage.removeItem("tallerazo_otp"); }

/* EmailJS REST - CÃ“DIGO CORREGIDO (Email y Passcode) */
async function emailjsSendOTP(to_email, otp_code){
Â  const body = {
Â  Â  service_id: EMAILJS_SERVICE_ID,
Â  Â  template_id: EMAILJS_TEMPLATE_ID,
Â  Â  user_id: EMAILJS_PUBLIC_KEY,
Â  Â  template_params: { 
        email: to_email, 
        passcode: otp_code, 
        app_name: APP_NAME 
    }
Â  };
Â  const r = await fetch("https://api.emailjs.com/api/v1.0/email/send",{
Â  Â  method:"POST",
Â  Â  headers:{ "Content-Type":"application/json" },
Â  Â  body: JSON.stringify(body)
Â  });
Â  if(!r.ok){ 
    const errorText = await r.text();
    console.error("EmailJS Error Response:", errorText);
    throw new Error(errorText); 
  }
}

/* =========================
Â  Â ğŸ§­ Mini Router (hash)
Â  Â ========================= */
const routes = {
Â  "/login": renderLogin,
Â  "/home": renderHome,
  "/ubicacion": renderUbicacion // Nueva ruta
};

function navigate(path){ 
    location.hash = "#" + path; 
}

function router(){
    const path = location.hash.replace("#","") || "/login";
    const view = routes[path] || renderNotFound;
    
    // Mantenemos el bot siempre visible, no es necesario llamar a toggleBot
    
    document.getElementById("app").innerHTML = view();
    view.afterRender && view.afterRender();
}
window.addEventListener("hashchange", router);
window.addEventListener("load", router);


/* =========================
Â  Â ğŸ§© Vistas / Componentes
Â  Â ========================= */
function renderLogin(){
Â  // El cÃ³digo del login permanece igual
Â  return `
Â  <div class="card">
Â  Â  <h1>ğŸ”§ ${APP_NAME}</h1>
Â  Â  <p>Inicio de sesiÃ³n seguro con cÃ³digo OTP (One-Time Password) enviado a tu correo.</p>

Â  Â  <div class="row">
Â  Â  Â  <input id="email" type="email" placeholder="Ingresa tu correo (ej. tu@gmail.com)" autocomplete="email">
Â  Â  Â  <button id="sendBtn">Enviar CÃ³digo OTP</button>
Â  Â  Â  <span id="msg" class="mut"></span>
Â  Â  </div>

Â  Â  <div id="otpBlock" class="row hidden">
Â  Â  Â  <input id="otp" type="text" maxlength="6" placeholder="CÃ³digo de 6 dÃ­gitos">
Â  Â  Â  <button id="verifyBtn">Verificar y Entrar</button>
Â  Â  </div>

Â  Â  <p class="mut">* El cÃ³digo es vÃ¡lido por 5 minutos y solo funciona una vez.</p>
Â  </div>
Â  `;
}
renderLogin.afterRender = function(){
Â  const emailEl = document.getElementById("email");
Â  const otpEl = document.getElementById("otp");
Â  const sendBtn = document.getElementById("sendBtn");
Â  const verifyBtn = document.getElementById("verifyBtn");
Â  const msg = document.getElementById("msg");
Â  const otpBlock = document.getElementById("otpBlock");

Â  function show(t, cls="mut"){ msg.className = cls; msg.textContent = t; }

Â  sendBtn.addEventListener("click", async ()=>{
Â  Â  const email = (emailEl.value||"").trim();
Â  Â  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ show("Correo invÃ¡lido. Verifica el formato.", "bad"); return; }
Â  Â  sendBtn.disabled = true; show("Enviando cÃ³digo, espera un momento... â³");
Â  Â  try{
Â  Â  Â  const code = genOTP();
Â  Â  Â  const hash = await sha256(code + email.toLowerCase());
Â  Â  Â  saveOtp(email, hash);

Â  Â  Â  await emailjsSendOTP(email, code);
Â  Â  Â  show("CÃ³digo enviado con Ã©xito. Revisa tu bandeja de entrada ğŸ“©", "ok");
Â  Â  Â  otpBlock.classList.remove("hidden");
Â  Â  }catch(e){
Â  Â  Â  console.error(e);
Â  Â  Â  show("No se pudo enviar el correo: " + (e.message.includes("400") ? "Verifica tus IDs de EmailJS." : e.message), "bad");
Â  Â  }finally{
Â  Â  Â  sendBtn.disabled = false;
Â  Â  }
Â  });

Â  verifyBtn.addEventListener("click", async ()=>{
Â  Â  const otpRec = readOtp();
Â  Â  if(!otpRec){ show("No hay cÃ³digo activo. Haz clic en 'Enviar CÃ³digo OTP'.", "bad"); return; }
Â  Â  if(Date.now() > otpRec.exp){ clearOtp(); show("CÃ³digo expirado. SolicÃ­talo otra vez.", "bad"); return; }

Â  Â  const email = (emailEl.value||"").trim().toLowerCase();
Â  Â  const code = (otpEl.value||"").trim();
Â  Â  if(code.length !== 6){ show("CÃ³digo invÃ¡lido. Debe tener 6 dÃ­gitos.", "bad"); return; }
    
Â  Â  otpRec.attempts++;
Â  Â  if(otpRec.attempts > 5){ clearOtp(); show("Demasiados intentos fallidos. Solicita un cÃ³digo nuevo.", "bad"); return; }

Â  Â  const hash = await sha256(code + email);
Â  Â  if(hash === otpRec.otpHash){
Â  Â  Â  clearOtp();
Â  Â  Â  sessionStorage.setItem("tallerazo_session", JSON.stringify({ email, ts: Date.now() }));
Â  Â  Â  navigate("/home");
Â  Â  }else{
Â  Â  Â  sessionStorage.setItem("tallerazo_otp", JSON.stringify(otpRec)); // persist attempts
Â  Â  Â  show("CÃ³digo incorrecto. Intento " + otpRec.attempts + "/5.", "bad");
Â  Â  }
Â  });
};

function renderHome(){
Â  const session = JSON.parse(sessionStorage.getItem("tallerazo_session") || "null");
Â  if(!session){ setTimeout(()=>navigate("/login"),0); return ""; }
Â  const email = session.email;

Â  return `
Â  <div class="card">
Â  Â  <div class="header">
Â  Â  Â  <h2>ğŸ Dashboard â€“ ${APP_NAME}</h2>
Â  Â  Â  <span class="badge">Usuario: ${email}</span>
Â  Â  Â  </div>
Â  Â  <nav>
Â  Â  Â  <a href="#/home" class="${location.hash === '#/home' ? 'active' : ''}">Inicio</a>
Â  Â  Â  <a href="#/ubicacion" class="${location.hash === '#/ubicacion' ? 'active' : ''}">ğŸ“ UbicaciÃ³n</a> 
Â  Â  Â  <a href="#/login" id="logoutLink">Cerrar SesiÃ³n</a>
Â  Â  </nav>
Â  Â  <p>Bienvenido. AquÃ­ puedes gestionar diagnÃ³sticos y citas. Toda la informaciÃ³n se guarda de forma local en tu navegador.</p>
Â  Â  <div class="grid">
Â  Â  Â  <div class="tile">
Â  Â  Â  Â  <h3>ğŸ” DiagnÃ³stico RÃ¡pido</h3>
Â  Â  Â  Â  <p class="mut">Escribe un sÃ­ntoma y obtÃ©n una sugerencia de servicio.</p>
Â  Â  Â  Â  <div class="toolbar">
Â  Â  Â  Â  Â  <input id="sym" placeholder="e.g. Ruido al frenar o VibraciÃ³n">
Â  Â  Â  Â  Â  <button id="btnDiag">Sugerir</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="outDiag" class="mut"></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="tile">
Â  Â  Â  Â  <h3>ğŸ—“ï¸ Agendar Nueva Cita</h3>
Â  Â  Â  Â  <p class="mut">SimulaciÃ³n: Registra los detalles de tu cita.</p>
Â  Â  Â  Â  <div class="toolbar">
Â  Â  Â  Â  Â  <input id="taller" placeholder="Taller Preferido">
Â  Â  Â  Â  Â  <input id="fecha" type="date">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="btnCita">Guardar Cita</button>
Â  Â  Â  Â  <div id="outCita" class="mut"></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="tile">
Â  Â  Â  Â  <h3>ğŸ“œ Historial de Actividad</h3>
Â  Â  Â  Â  <div id="hist" class="mut">Sin datos aÃºn.</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â  `;
}
renderHome.afterRender = function(){
Â  // La lÃ³gica del Dashboard permanece igual
Â  const logout = document.getElementById("logoutLink");
Â  logout && logout.addEventListener("click", ()=>{
Â  Â  sessionStorage.removeItem("tallerazo_session");
Â  });

Â  const diagBtn = document.getElementById("btnDiag");
Â  const sym = document.getElementById("sym");
Â  const out = document.getElementById("outDiag");
Â  diagBtn.addEventListener("click", ()=>{
Â  Â  const s=(sym.value||"").toLowerCase();
Â  Â  let msg="LlÃ©valo a revisiÃ³n general.";
Â  Â  if(s.includes("freno")) msg="RevisiÃ³n de frenos (pastillas/discos).";
Â  Â  else if(s.includes("vibrac")) msg="AlineaciÃ³n y balanceo recomendado.";
Â  Â  else if(s.includes("humo")) msg="Revisar motor/aceite.";
Â  Â  else if(s.includes("bater")) msg="Revisar baterÃ­a o alternador.";
Â  Â  out.textContent = "Sugerencia: " + msg;
Â  Â  pushHist("DiagnÃ³stico", s + " â†’ " + msg);
Â  });

Â  const btnCita = document.getElementById("btnCita");
Â  const taller = document.getElementById("taller");
Â  const fecha = document.getElementById("fecha");
Â  const outCita = document.getElementById("outCita");
Â  btnCita.addEventListener("click", ()=>{
Â  Â  if(!taller.value || !fecha.value){ outCita.textContent="Completa los campos de taller y fecha."; return; }
Â  Â  const item = `Cita: ${taller.value} â€“ ${fecha.value}`;
Â  Â  pushHist("Cita", item);
Â  Â  outCita.className = "ok";
Â  Â  outCita.textContent = "âœ… Cita guardada (localmente).";
Â  Â  taller.value=""; fecha.value="";
Â  });

Â  renderHist();
};

/* =========================
Â  Â ğŸ—ºï¸ VISTA UBICACIÃ“N
Â  Â ========================= */
const SUCURSALES = [
    { name: "Sucursal San Salvador", coords: [13.6929, -89.2182], address: "Av. Roosevelt #123", image: "https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=800&q=80" },
    { name: "Sucursal Santa Ana", coords: [13.9946, -89.5597], address: "Calle Libertad #45", image: "https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?w=800&q=80" },
    { name: "Sucursal Chalatenango", coords: [14.0833, -89.0333], address: "Centro Comercial Norte", image: "https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&q=80" },
    { name: "Sucursal El Rosario", coords: [13.49778, -89.02972], address: "Barrio El Centro, La Paz", image: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=800&q=80" },
    { name: "Sucursal Zacatecoluca", coords: [13.5019, -88.8625], address: "Av. JosÃ© SimeÃ³n CaÃ±as #88", image: "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=800&q=80" }
];

function renderUbicacion(){
    const session = JSON.parse(sessionStorage.getItem("tallerazo_session") || "null");
    if(!session){ setTimeout(()=>navigate("/login"),0); return ""; }
    
    const branchCards = SUCURSALES.map(s => `
        <a href="https://maps.app.goo.gl/FuajwB3kZqTdorbA6" target="_blank" class="branch-card">
            <img src="${s.image}" alt="${s.name}" class="branch-image" />
            <div class="branch-info">
                <h3>${s.name}</h3>
                <p>ğŸ“ ${s.address}</p>
                <span class="branch-link">Ver en el mapa â†’</span>
            </div>
        </a>
    `).join('');

    return `
    <div class="card map-container">
        <div class="header">
            <h2>ğŸ Dashboard â€“ ${APP_NAME}</h2>
            <span class="badge">Usuario: ${session.email}</span>
        </div>
        <nav>
            <a href="#/home" class="${location.hash === '#/home' ? 'active' : ''}">Inicio</a>
            <a href="#/ubicacion" class="${location.hash === '#/ubicacion' ? 'active' : ''}">ğŸ“ UbicaciÃ³n</a> 
            <a href="#/login" id="logoutLink">Cerrar SesiÃ³n</a>
        </nav>
        
        <div class="map-header">
            <h2>ğŸ“ Nuestras Sucursales</h2>
        </div>
        
        <div id="map-sucursales"></div>

        <div class="branches">
            <h2 class="section-title">ğŸ¢ Lista de Ubicaciones</h2>
            ${branchCards}
        </div>
    </div>
    `;
}

renderUbicacion.afterRender = function(){
    const logout = document.getElementById("logoutLink");
Â  Â  logout && logout.addEventListener("click", ()=>{
Â  Â  Â  sessionStorage.removeItem("tallerazo_session");
Â  Â  });
    
    // Inicializar el mapa despuÃ©s de que el elemento se ha insertado en el DOM
    setTimeout(() => {
        try {
            // Verifica si el mapa ya existe para evitar errores de Leaflet al recargar la vista
            if (document.getElementById('map-sucursales')._leaflet_id) {
                document.getElementById('map-sucursales')._leaflet_id = null;
            }
            
            const map = L.map('map-sucursales').setView([13.80, -88.85], 8); // Centrado en El Salvador

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18,
            }).addTo(map);

            // Agregar marcadores
            SUCURSALES.forEach(s => {
                L.marker(s.coords).addTo(map)
                    .bindPopup(`<b>${s.name}</b><br>${s.address}`);
            });
            
            // Forzar un 'invalidateSize' para asegurar que el mapa se muestre correctamente
            map.invalidateSize(); 

        } catch (e) {
            console.error("Error al inicializar Leaflet (AsegÃºrate de que la biblioteca estÃ© cargada y el contenedor exista):", e);
        }
    }, 0); // PequeÃ±o retraso para asegurar que el DOM estÃ© actualizado
};


function renderNotFound(){ return `<div class="card"><h2>Ruta no encontrada</h2><p class="mut"><a href="#/login">Ir al Login</a></p></div>`; }

/* ======= Utilidades â€œestado/almacenamientoâ€ ======= */
function pushHist(tipo, detalle){
Â  const k="tallerazo_hist";
Â  const arr = JSON.parse(localStorage.getItem(k)||"[]");
Â  arr.unshift({ts:new Date().toISOString(), tipo, detalle});
Â  localStorage.setItem(k, JSON.stringify(arr.slice(0,50)));
Â  renderHist();
}
function renderHist(){
Â  const el=document.getElementById("hist"); if(!el) return;
Â  const arr = JSON.parse(localStorage.getItem("tallerazo_hist")||"[]");
Â  if(arr.length===0){ el.textContent="Sin datos aÃºn."; return; }
Â  el.innerHTML = arr.map(i=>`<div style="margin-bottom: 8px; border-bottom: 1px dotted var(--border); padding-bottom: 5px;">â€¢ <b>${i.tipo}</b> â€“ ${i.detalle} <span style="display:block; font-size: 11px;" class="mut">(${new Date(i.ts).toLocaleString()})</span></div>`).join("");
}
</script>
</body>
</html>